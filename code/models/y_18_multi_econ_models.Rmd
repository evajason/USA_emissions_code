---
title: "y_18_multi_econ_models"
author: "Yanelli Nunez"
date: "3/8/2022"
output:
 html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

Objective:
Test various versions of the models as sensitivity analysis. We tested the following model designs:

- 1) Black and white plus confounding variables (All emissions sources)
- 2) One race variable with all economic variables and confounding variables (SO2 from Industry)
- 3) All races in the model plus confounding variables

######################

- NOx from transport 
- NH3 from agriculture 
- SO2 from energy --> Selected 95th percentile of data which excluded extreme values
- NOx from energy --> Selected 95th percentile of data which excluded extreme values
- SO2 from industry  --> I removed the observations with "infinity" emissions with was a total of 5 per year and replace the NaN with zero
- OC from residential
- NOx from commercial

```{r include=FALSE}

rm(list=ls())

# 1a Declare root directory
project.folder <- paste0(print(here::here()),'/')

# add folder locations
source(paste0(project.folder,'0_00_create_folder_structure.R'))

# add file locations
source(paste0(file.locations.folder,'external_file_locations.R'))

# load packages
source(paste0(packages.folder,'packages_to_load.R'))

# load functions
source(paste0(code.folder, 'models/functions_yanelli.R'))

# load data
source(paste0(code.folder, 'data_loading.R'))

```


## 1. View data
```{r}

summary(data_master)
class(data_master)

```


## 2. Run models 

These models include percent black and white simultaneously 

```{r}

### nox from transport
nox_transp_model <- gamm4::gamm4(nox_trans_relat_chg ~
                       s(perc_white) +
                       s(perc_asian) +
                       s(pop_density) +
                       urbanicity +
                       epa_reg + 
               as.factor(year),
                random = ~(1|state/gisjoin), 
                     data = data_master)

summary(nox_transp_model[[2]])
plot(nox_transp_model[[2]])
abline(h=0)
## so2 from industry 
o2_inds_model <- gamm4::gamm4(so2_indus_relat_chg ~
                       s(perc_white) +
                       s(perc_black) +
                       s(pop_density) +
                       urbanicity +
                       epa_reg + 
               as.factor(year),
                random = ~(1|state/gisjoin), 
                     data = so2_inds)
summary(so2_inds_model[[2]])
plot(so2_inds_model[[2]], select = 2)
abline(h=0)
## so2 from energy
o2_ener_model <- gamm4::gamm4(so2_energy_relat_chg ~
                       s(perc_white) +
                       s(perc_black) +
                       s(pop_density) +
                       urbanicity +
                       epa_reg + 
               as.factor(year),
                random = ~(1|state/gisjoin), 
                     data = so2_energy)
summary(so2_ener_model[[2]])
plot(so2_ener_model[[2]], select = 1)
abline(h=0)
## nox from energy
ox_ener_model <- gamm4::gamm4(nox_energy_relat_chg ~
                       s(perc_white) +
                       s(perc_black) +
                       s(pop_density) +
                       urbanicity +
                       epa_reg + 
               as.factor(year),
                random = ~(1|state/gisjoin), 
                     data = nox_energy)
summary(nox_ener_model[[2]])
plot(nox_ener_model[[2]], select = 2)
abline(h=0)
## nh3 from agriculture
h3_agri_model <- gamm4::gamm4(nh3_agric_relat_chg ~
                       s(perc_white) +
                       s(perc_black) +
                       s(pop_density) +
                       urbanicity +
                       epa_reg + 
               as.factor(year),
                random = ~(1|state/gisjoin), 
                     data = data_master)
summary(nh3_agri_model[[2]])
plot(nh3_agri_model[[2]], select = 2)
abline(h=0)
## oc from residence
c_resid_model <- gamm4::gamm4(oc_resid_relat_chg ~
                       s(perc_white) +
                       s(perc_black) +
                       s(pop_density) +
                       urbanicity +
                       epa_reg + 
               as.factor(year),
                random = ~(1|state/gisjoin), 
                     data = data_master)
summary(oc_resid_model[[2]])
plot(oc_resid_model[[2]], select = 2)
abline(h=0)
## nox commercial 
ox_comm_model <- gamm4::gamm4(nox_commer_relat_chg ~
                       s(perc_white) +
                       s(perc_black) +
                       s(pop_density) +
                       urbanicity +
                       epa_reg + 
               as.factor(year),
                random = ~(1|state/gisjoin), 
                     data = data_master)
summary(nox_comm_model[[2]])
plot(nox_comm_model[[2]], select = 1)
abline(h=0)
```

### 2a. Plot visuals 

```{r}

#par(mfrow=c(3,2))
#
## NOx energy
#plot(nox_ener_model[[2]], select = 1, ylab = "NOx Energy")
#abline(h=0, col = "blue")
#plot(nox_ener_model[[2]], select = 2, ylab= "NOx Energy") 
#abline(h=0, col = "blue")
#
## SO2 energy 
#plot(so2_ener_model[[2]], select = 1, ylab = "SO2 Energy")
#abline(h=0, col = "blue")
#plot(so2_ener_model[[2]], select = 2, ylab = "SO2 Energy")
#abline(h=0, col = "blue")
#
#
## SO2 industry
#plot(so2_inds_model[[2]], select = 1, ylab = "SO2 Industry")
#abline(h=0, col = "blue")
#plot(so2_inds_model[[2]], select = 2, ylab = "SO2 Industry")
#abline(h=0, col = "blue")
#
#
#par(mfrow=c(4,2))
## nox from commerce
#plot(nox_comm_model[[2]], select = 1, ylab = "NOx Commercial")
#abline(h=0, col = "blue")
#plot(nox_comm_model[[2]], select = 2, ylab = "NOx Commercial")
#abline(h=0, col = "blue")
#
## nh3 agriculture
#plot(nh3_agri_model[[2]], select = 1, ylab = "NH3 Agriculture")
#abline(h=0, col = "blue")
#plot(nh3_agri_model[[2]], select = 2, ylab = "NH3 Agriculture")
#abline(h=0, col = "blue")
#
#
## OC residence
#plot(oc_resid_model[[2]], select = 1, ylab = "OC Residencial")
#abline(h=0, col = "blue")
#plot(oc_resid_model[[2]], select = 2, ylab = "OC Residencial")
#abline(h=0, col = "blue")
#
## nox from transport
#plot(nox_transp_model[[2]], select = 1, ylab = "NOx Transportation")
#abline(h=0, col = "blue")
#plot(nox_transp_model[[2]], select = 2, ylab = "NOx Transportation")
#abline(h=0, col = "blue")


```


## 3. Models with multi-eco variables

These models are for the SO2 industry sector. The models include all economic variables and one race variable in a time

```{r}

### white
so2_inds_model_white <- gamm4::gamm4(so2_indus_relat_chg ~
                        s(perc_white) +
                          pop_density +
                          s(perc_unemp) +
                          s(perc_pvert) +
                          s(fam_incom_adjs) +
                          s(propty_val_adjs) +
                        urbanicity +
                        epa_reg + 
                as.factor(year),
                 random = ~(1|state/gisjoin), 
                      data = so2_inds)

#summary(so2_inds_model.white[[2]])
plot(so2_inds_model_white[[2]])


### black
so2_inds_model_black <- gamm4::gamm4(so2_indus_relat_chg ~
                        s(perc_black) +
                          pop_density +
                          s(perc_unemp) +
                          s(perc_pvert) +
                          s(fam_incom_adjs) +
                          s(propty_val_adjs) +
                        urbanicity +
                        epa_reg + 
                as.factor(year),
                 random = ~(1|state/gisjoin), 
                      data = so2_inds)

#summary(so2_inds_model.black[[2]])
plot(so2_inds_model_black[[2]])


### Asian
so2_inds_model_asian <- gamm4::gamm4(so2_indus_relat_chg ~
                        s(perc_asian) +
                          pop_density +
                          s(perc_unemp) +
                          s(perc_pvert) +
                          s(fam_incom_adjs) +
                          s(propty_val_adjs) +
                        urbanicity +
                        epa_reg + 
                as.factor(year),
                 random = ~(1|state/gisjoin), 
                      data = so2_inds)

#summary(so2_inds_model_asian[[2]])
plot(so2_inds_model_asian[[2]])


# American Native 
so2_inds_model_nativ <- gamm4::gamm4(so2_indus_relat_chg ~
                        s(perc_nativ) +
                          pop_density +
                          s(perc_unemp) +
                          s(perc_pvert) +
                          s(fam_incom_adjs) +
                          s(propty_val_adjs) +
                        urbanicity +
                        epa_reg + 
                as.factor(year),
                 random = ~(1|state/gisjoin), 
                      data = so2_inds)

#summary(so2_inds_model_nativ[[2]])
plot(so2_inds_model_nativ[[2]])


# hispanic 
so2_inds_model_hisp <- gamm4::gamm4(so2_indus_relat_chg ~
                        s(perc_hisp_org) +
                          pop_density +
                          s(perc_unemp) +
                          s(perc_pvert) +
                          s(fam_incom_adjs) +
                          s(propty_val_adjs) +
                        urbanicity +
                        epa_reg + 
                as.factor(year),
                 random = ~(1|state/gisjoin), 
                      data = so2_inds)

#summary(so2_inds_model_hisp[[2]])
plot(so2_inds_model_hisp[[2]])

```

## 4. Multi-race models 

```{r}

so2_inds_model_mult_race <- gamm4::gamm4(so2_indus_relat_chg ~
                        s(perc_hisp_org) +
                          pop_density +
                          s(perc_black) +
                          s(perc_white) +
                          s(perc_asian) +
                          s(perc_nativ) +
                        urbanicity +
                        epa_reg + 
                as.factor(year),
                 random = ~(1|state/gisjoin), 
                      data = so2_inds)

#summary(so2_inds_model_mult_race[[2]])
plot(so2_inds_model_mult_race[[2]])
```

